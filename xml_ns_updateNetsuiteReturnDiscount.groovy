/* @data
<ns1:ReturnAuthorization xmlns:ns1="urn:customers_2016_2.transactions.webservices.netsuite.com" xmlns:ns2="urn:core_2016_2.platform.webservices.netsuite.com" xmlns:ns3="urn:common_2016_2.platform.webservices.netsuite.com" externalId="3ee20dc2-0a5e-11ea-afc6-0242ac110003_1854239604849_Refund_RA">
	<ns1:createdDate>2019-11-05T18:36:00.000-05:00</ns1:createdDate>
	<ns1:lastModifiedDate>2019-11-07T12:49:00.000-05:00</ns1:lastModifiedDate>
	<ns1:customForm internalId="122">
    DJ Return Authorization - Credit
		<ns2:name>DJ Return Authorization - Credit</ns2:name>
	</ns1:customForm>
	<ns1:entity internalId="1689268">
		<ns2:name>CUST76518 Brooke Jeffy</ns2:name>
	</ns1:entity>
	<ns1:tranDate>2019-11-21T14:31:36.000-05:00</ns1:tranDate>
	<ns1:tranId>To Be Generated</ns1:tranId>
	<ns1:source>Web Services</ns1:source>
	<ns1:department internalId="4">
		<ns2:name>Merchandising</ns2:name>
	</ns1:department>
	<ns1:location internalId="16" />
	<ns1:memo>Refund Option: Refund</ns1:memo>
	<ns1:salesEffectiveDate>2019-11-05T00:00:00.000-05:00</ns1:salesEffectiveDate>
	<ns1:createdFrom internalId="11352754">
		<ns2:name>Sales Order #SO272192</ns2:name>
	</ns1:createdFrom>
	<ns1:totalCostEstimate>28.73</ns1:totalCostEstimate>
	<ns1:estGrossProfit>-28.73</ns1:estGrossProfit>
	<ns1:billingAddress>
		<ns3:country>_unitedStates</ns3:country>
		<ns3:addr1>5247 East Barwick dr</ns3:addr1>
		<ns3:city>Cave Creek</ns3:city>
		<ns3:state>AZ</ns3:state>
		<ns3:zip>85331</ns3:zip>
		<ns3:addrText>5247 East Barwick dr
Cave Creek AZ 85331
United States</ns3:addrText>
		<ns3:override>false</ns3:override>
	</ns1:billingAddress>
	<ns1:subTotal>0.0</ns1:subTotal>
	<ns1:discountTotal>0.0</ns1:discountTotal>
	<ns1:total>0.0</ns1:total>
	<ns1:email>Brooke.Jeffy@gmail.com</ns1:email>
	<ns1:taxTotal>0.0</ns1:taxTotal>
	<ns1:orderStatus>_pendingReceipt</ns1:orderStatus>
	<ns1:itemList>
		<ns1:item>
			<ns1:item internalId="47725">
				<ns2:name>DRW0589 : DRW05894122 Magnolia Shirtdress</ns2:name>
			</ns1:item>
			<ns1:orderLine>1</ns1:orderLine>
			<ns1:line>1</ns1:line>
			<ns1:quantity>1</ns1:quantity>
			<ns1:quantityReceived>1.0</ns1:quantityReceived>
			<ns1:price internalId="-1" />
			<ns1:rate>88.00</ns1:rate>
			<ns1:isDropShipment>false</ns1:isDropShipment>
			<ns1:costEstimateType>_averageCost</ns1:costEstimateType>
			<ns1:costEstimate>28.73</ns1:costEstimate>
			<ns1:location internalId="16" />
			<ns1:taxCode internalId="7126">
				<ns2:name>AVATAX</ns2:name>
			</ns1:taxCode>
			<ns1:taxRate1>0.0</ns1:taxRate1>
			<ns1:customFieldList>
				<ns2:Apply_WH_Tax_ internalId="1135" scriptId="custcol_4601_witaxapplies">
          false
					<ns2:value>false</ns2:value>
				</ns2:Apply_WH_Tax_>
				<ns2:Product_Color_Description internalId="1272" scriptId="custcol_dj_product_color_description">
					<ns2:value>Nassau Navy Multi</ns2:value>
				</ns2:Product_Color_Description>
				<ns2:Reason_for_Return>
					<ns2:value>changed_my_mind</ns2:value>
				</ns2:Reason_for_Return>
				<ns2:Item_Type internalId="2101" scriptId="custcol9">
					<ns2:value>Inventory Item</ns2:value>
				</ns2:Item_Type>
			</ns1:customFieldList>
		</ns1:item>
		<ns1:item>
			<ns1:item internalId="7108">
				<ns2:name>Discount Item Discount Item</ns2:name>
			</ns1:item>
			<ns1:orderLine>2</ns1:orderLine>
			<ns1:line>2</ns1:line>
			<ns1:price internalId="-1" />
			<ns1:rate>-100.00%</ns1:rate>
			<ns1:isDropShipment>false</ns1:isDropShipment>
			<ns1:location internalId="16" />
			<ns1:taxCode internalId="7126">
				<ns2:name>AVATAX</ns2:name>
			</ns1:taxCode>
			<ns1:taxRate1>0.0</ns1:taxRate1>
			<ns1:customFieldList>
				<ns2:Apply_WH_Tax_ internalId="1135" scriptId="custcol_4601_witaxapplies">
          false
					<ns2:value>false</ns2:value>
				</ns2:Apply_WH_Tax_>
				<ns2:Promo_Code internalId="1278" scriptId="custcol_dj_promocode">
					<ns2:value>EXCHANGE</ns2:value>
				</ns2:Promo_Code>
				<ns2:Item_Type internalId="2101" scriptId="custcol9">
					<ns2:value>Discount</ns2:value>
				</ns2:Item_Type>
			</ns1:customFieldList>
		</ns1:item>
		<ns1:item>
			<ns1:item internalId="47725">
				<ns2:name>DRW0589 : DRW05894122 Magnolia Shirtdress</ns2:name>
			</ns1:item>
			<ns1:orderLine>1</ns1:orderLine>
			<ns1:line>3</ns1:line>
			<ns1:quantity>2</ns1:quantity>
			<ns1:quantityReceived>2</ns1:quantityReceived>
			<ns1:price internalId="-1" />
			<ns1:rate>50.00</ns1:rate>
			<ns1:isDropShipment>false</ns1:isDropShipment>
			<ns1:costEstimateType>_averageCost</ns1:costEstimateType>
			<ns1:costEstimate>28.73</ns1:costEstimate>
			<ns1:location internalId="16" />
			<ns1:taxCode internalId="7126">
				<ns2:name>AVATAX</ns2:name>
			</ns1:taxCode>
			<ns1:taxRate1>0.0</ns1:taxRate1>
			<ns1:customFieldList>
				<ns2:Apply_WH_Tax_ internalId="1135" scriptId="custcol_4601_witaxapplies">
          false
					<ns2:value>false</ns2:value>
				</ns2:Apply_WH_Tax_>
				<ns2:Product_Color_Description internalId="1272" scriptId="custcol_dj_product_color_description">
					<ns2:value>Nassau Navy Multi</ns2:value>
				</ns2:Product_Color_Description>
				<ns2:Reason_for_Return>
					<ns2:value>changed_my_mind</ns2:value>
				</ns2:Reason_for_Return>
				<ns2:Item_Type internalId="2101" scriptId="custcol9">
					<ns2:value>Inventory Item</ns2:value>
				</ns2:Item_Type>
			</ns1:customFieldList>
		</ns1:item>
		<ns1:item>
			<ns1:item internalId="7108">
				<ns2:name>Discount Item Discount Item</ns2:name>
			</ns1:item>
			<ns1:orderLine>2</ns1:orderLine>
			<ns1:line>4</ns1:line>
			<ns1:price internalId="-1" />
			<ns1:rate>-10.00%</ns1:rate>
			<ns1:isDropShipment>false</ns1:isDropShipment>
			<ns1:location internalId="16" />
			<ns1:taxCode internalId="7126">
				<ns2:name>AVATAX</ns2:name>
			</ns1:taxCode>
			<ns1:taxRate1>0.0</ns1:taxRate1>
			<ns1:customFieldList>
				<ns2:Apply_WH_Tax_ internalId="1135" scriptId="custcol_4601_witaxapplies">
          false
					<ns2:value>false</ns2:value>
				</ns2:Apply_WH_Tax_>
				<ns2:Promo_Code internalId="1278" scriptId="custcol_dj_promocode">
					<ns2:value>EXCHANGE</ns2:value>
				</ns2:Promo_Code>
				<ns2:Item_Type internalId="2101" scriptId="custcol9">
					<ns2:value>Discount</ns2:value>
				</ns2:Item_Type>
			</ns1:customFieldList>
		</ns1:item>
		<ns1:item>
			<ns1:item internalId="7108">
				<ns2:name>Discount Item Discount Item</ns2:name>
			</ns1:item>
			<ns1:orderLine>2</ns1:orderLine>
			<ns1:line>5</ns1:line>
			<ns1:price internalId="-1" />
			<ns1:rate>-4.99</ns1:rate>
			<ns1:isDropShipment>false</ns1:isDropShipment>
			<ns1:location internalId="16" />
			<ns1:taxCode internalId="7126">
				<ns2:name>AVATAX</ns2:name>
			</ns1:taxCode>
			<ns1:taxRate1>0.0</ns1:taxRate1>
			<ns1:customFieldList>
				<ns2:Apply_WH_Tax_ internalId="1135" scriptId="custcol_4601_witaxapplies">
          false
					<ns2:value>false</ns2:value>
				</ns2:Apply_WH_Tax_>
				<ns2:Promo_Code internalId="1278" scriptId="custcol_dj_promocode">
					<ns2:value>EXCHANGE</ns2:value>
				</ns2:Promo_Code>
				<ns2:Item_Type internalId="2101" scriptId="custcol9">
					<ns2:value>Discount</ns2:value>
				</ns2:Item_Type>
			</ns1:customFieldList>
		</ns1:item>
	</ns1:itemList>
	<ns1:customFieldList>
		<ns2:Returns_Channel>
			<ns2:value>By mail</ns2:value>
		</ns2:Returns_Channel>
		<ns2:Document_Date internalId="688" scriptId="custbody_document_date">
			<ns2:value>2019-11-05T00:00:00.000-05:00</ns2:value>
		</ns2:Document_Date>
		<ns2:Gift_Wrap internalId="1327" scriptId="custbody_gift_wrap">
			<ns2:value>false</ns2:value>
		</ns2:Gift_Wrap>
		<ns2:Is_Seller_Importer_Of_Record internalId="1984" scriptId="custbody_ava_is_sellerimporter">
      false
			<ns2:value>false</ns2:value>
		</ns2:Is_Seller_Importer_Of_Record>
		<ns2:Order_Type internalId="1273" scriptId="custbody_dj_ordertype">
			<ns2:value internalId="1" typeId="225">
        Web
				<ns2:name>Web</ns2:name>
			</ns2:value>
		</ns2:Order_Type>
		<ns2:Store_Order__ internalId="1992" scriptId="custbody_dj_store_order_number">
			<ns2:value>200327489</ns2:value>
		</ns2:Store_Order__>
		<ns2:Store_Order_Total internalId="1993" scriptId="custbody_dj_store_order_total">
			<ns2:value>0.0</ns2:value>
		</ns2:Store_Order_Total>
	</ns1:customFieldList>
</ns1:ReturnAuthorization>
*/

//Remove Element Based on Value with Element

import java.util.Properties;
import java.io.InputStream;
import java.util.*;
import org.jdom.input.SAXBuilder;
import org.jdom.Document;
import org.jdom.Namespace; 
import org.jdom.Element;
import org.jdom.xpath.XPath;
import org.jdom.output.XMLOutputter;
import com.boomi.execution.ExecutionUtil;
// import com.boomi.execution.ExecutionManager;
     
logger = ExecutionUtil.getBaseLogger();
	 
// Loop through the Process Documents
for ( int i = 0; i < dataContext.getDataCount(); i++ ) {

     InputStream is = dataContext.getStream(i);
     Properties props = dataContext.getProperties(i);

     // Build XML Document
     SAXBuilder builder = new SAXBuilder();
     Document doc = builder.build(is);
     
	 //Parse through xml to get the child elements of EventLists	 
	 XPath x = XPath.newInstance("//ns1:ReturnAuthorization/ns1:itemList");
	 x.addNamespace("ns1","urn:customers_2016_2.transactions.webservices.netsuite.com");
	 
	 Element parent = x.selectSingleNode(doc);

     List<Element> DocChildren= parent.getChildren();
	 
	 // Set Variables
	 String removeItem = "false";
	 String previousType = "START";
	 String currentType = "";
	 String itemID = "";
	 String qtyReturned = "0";
	 String qtyOrdered = "0";
	 double itemReturned = 0;
	 double itemOrdered = 0;
	 String rate = "";
	 String discountChar = "";
	 double rateInt = 0;
	 double newRate = 0;
	 String newRateStr = "";
	 double runningtotal = 0;
	 double previousItemAmnt = 0;
	 String refund_channel = "";
	 String refund_option = "";

	 
	 // Loop and Remove Elements
     for ( int j = 0; j < DocChildren.size(); j++ ) {
		
		logger.info("j="+ j-1 + ", runningtotal: " + runningtotal);
		logger.info("j="+ j-1 + ", previousItemAmnt: " + previousItemAmnt);
		
		Element DocChild = DocChildren.get(j);
		
		//Get Element Values
		Element ItemItemElement = DocChild.getChild("item", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
		if (ItemItemElement != null)
			itemID = ItemItemElement.getAttributeValue("internalId");
		
		Element ItemCustFieldsElement = DocChild.getChild("customFieldList", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
		Element ItemTypeElement = ItemCustFieldsElement.getChild("Item_Type", Namespace.getNamespace("urn:core_2016_2.platform.webservices.netsuite.com"));
		Element ItemTypeValueElement = ItemTypeElement.getChild("value", Namespace.getNamespace("urn:core_2016_2.platform.webservices.netsuite.com"));
		if (ItemTypeValueElement != null)
			currentType = ItemTypeValueElement.getValue();
		
		Element ItemQuantityElement = DocChild.getChild("quantity", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
		if (ItemQuantityElement != null)
			qtyReturned = ItemQuantityElement.getValue();
		
		Element ItemQuantityReceivedElement = DocChild.getChild("quantityReceived", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
		if (ItemQuantityReceivedElement != null)
			qtyOrdered = ItemQuantityReceivedElement.getValue();
		
		Element ItemRateElement = DocChild.getChild("rate", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
		if (ItemRateElement != null)
			rate = ItemRateElement.getValue();
		
		//Loop through items and update
		if (currentType == "Inventory Item" && !itemID) {
			removeItem = "true";
			previousType = currentType;
			itemID = "";
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			DocChild.detach();
			j = j - 1;
			continue;
		}
		
		if (currentType == "Inventory Item" && itemID) {
			removeItem = "false";
			previousType = currentType;
			itemID = "";
			itemReturned = Float.parseFloat(qtyReturned);
			itemOrdered = Float.parseFloat(qtyOrdered);
			rateInt = Float.parseFloat(rate);
			runningtotal = runningtotal + (rateInt * itemReturned)
			previousItemAmnt = rateInt * itemReturned;
			rateInt = 0;
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			DocChild.removeChild("quantityReceived", Namespace.getNamespace("urn:customers_2016_2.transactions.webservices.netsuite.com"));
			continue;
		}
		
		if (removeItem == "true" && currentType == "Discount") {
			previousType = currentType;
			itemID = "";
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			DocChild.detach();
			j = j - 1;
			continue;
		}
		
		if (previousType == "START" && currentType == "Discount") {
			previousType = currentType;
			itemID = "";
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			DocChild.detach();
			j = j - 1;
			continue;
		}
		
		if (currentType == "Discount" && removeItem == "false") {
			discountChar = rate.substring(rate.length() - 1);
			if (discountChar != "%") {
				rateInt = Float.parseFloat(rate);
				newRate = rateInt * itemReturned / itemOrdered;
				runningtotal = runningtotal + newRate;
				newRateStr = String.valueOf(newRate);
				((Element)ItemRateElement).setText(newRateStr);
			} else {
				discountPercentage = rate.substring(0, rate.length() - 1);
				logger.info("j="+ j + ", discountPercentage: " + discountPercentage);
				discountPercentageInt = Float.parseFloat(discountPercentage);
				newRate = previousItemAmnt * (discountPercentageInt / 100);
				logger.info("j="+ j + ", discountRate: " + newRate);
				runningtotal = runningtotal + newRate;
			}
			removeItem = "false";
			previousType = currentType;
			itemID = "";
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			discountChar = "";
			rateInt = 0;
			newRate = 0;
			discountPercentage = "";
			discountPercentageInt = 0;
			continue;
		}
		
		if (currentType != "Inventory Item" || currentType != "Discount") {
			previousType = currentType;
			itemID = "";
			qtyReturned = "0";
			qtyOrdered = "0";
			rate = "";
			DocChild.detach();
			j = j - 1;
			continue;
		}
		
     }
     
     //Add restocking Fee
	 
	 logger.info("final runningtotal: " + runningtotal);
	 
	 String returnID = props.getProperty("document.dynamic.userdefined.return_id");
	 
	 String totalReturnQtyProp = "return_id_" + returnID;
	 
	 String totalReturnQtyStringValue = "1"; //Updated to always be qty of 1 and -6.95 restocking fee on 3/6/20 per Leroy
	 
	 int totalReturnQtyIntValue = Integer.parseInt(totalReturnQtyStringValue);
	 logger.info("totalReturnQtyIntValue before update: " + totalReturnQtyIntValue);
	 
	 float restockingFeeValue = -6.95;
	 
	 float totalPossible = runningtotal / restockingFeeValue * -1;
	 
	 int totalPossibleInt = Math.floor(totalPossible);
	 
	 logger.info("Restocking Fee Qty totalPossibleInt: " + totalPossibleInt);
	 
	 if (totalPossibleInt < totalReturnQtyIntValue) {
		totalReturnQtyIntValue = totalPossibleInt;
		totalReturnQtyStringValue = String.valueOf(totalReturnQtyIntValue);
	 }
	 
	 logger.info("totalReturnQtyIntValue after update: " + totalReturnQtyIntValue);
	 
	 refund_channel = props.getProperty("document.dynamic.userdefined.refund_channel");
	 refund_option = props.getProperty("document.dynamic.userdefined.refund_option");
	 
	 if (totalReturnQtyIntValue > 0 && refund_channel == "By mail" && refund_option == "Refund") {
	 
		 Namespace ns1 = Namespace.getNamespace("ns1", "urn:customers_2016_2.transactions.webservices.netsuite.com");
		 Namespace ns2 = Namespace.getNamespace("ns2", "urn:core_2016_2.platform.webservices.netsuite.com");
		 
		 //create item in itemList
		 Element childItem = new Element("item",ns1);
		 
		 //create the item sub-elements
		 Element childItemItem = new Element("item",ns1);
		 ((Element)childItemItem).setAttribute("internalId","77778");
		 //test = 73278, prod = 77778
		 
		 Element childItemQuantity = new Element("quantity",ns1);
		 childItemQuantity.setText("1");
		 
		 Element childItemPrice = new Element("price",ns1);
		 ((Element)childItemPrice).setAttribute("internalId","-1");
		 
		 Element childItemRate = new Element("rate",ns1);
		 childItemRate.setText(String.valueOf(restockingFeeValue));
		 
		 Element childItemTaxCode = new Element("taxCode",ns1);
		 ((Element)childItemTaxCode).setAttribute("internalId","-7");
		 
		 Element childCustomFieldList = new Element("customFieldList",ns1);
		 
		 Element childItemType = new Element("Item_Type",ns2);
		 ((Element)childItemType).setAttribute("internalId","2101");
		 ((Element)childItemType).setAttribute("scriptId","custcol9");
		 
		 Element childItemTypeValue = new Element("value",ns2);
		 childItemTypeValue.setText(String.valueOf("Restocking Fee"));
		 
		 childItemType.addContent(childItemTypeValue);
		 childCustomFieldList.addContent(childItemType);
		 
		 //add sub-elements to item
		 childItem.addContent(childItemItem);
		 childItem.addContent(childItemQuantity);
		 childItem.addContent(childItemPrice);
		 childItem.addContent(childItemRate);
		 childItem.addContent(childItemTaxCode);
		 childItem.addContent(childCustomFieldList);
		 
		 //add item to itemList
		 parent.addContent(childItem);
	 }
	 
	 // Output the Document's data to an InputStream to pass to the next step in in process
     XMLOutputter outputter = new XMLOutputter();
     is = new ByteArrayInputStream(outputter.outputString(doc).getBytes("UTF-8"));

     dataContext.storeStream(is, props);

}
